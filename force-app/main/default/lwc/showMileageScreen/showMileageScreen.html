<template>
  <!-- Main Quick Action Content -->
  <div class="main-container">
    <div class="header">
      <lightning-icon
        icon-name="utility:travel_and_places"
        size="small"
        class="header-icon"
      ></lightning-icon>
      <h2 class="header-title">{labels.Mileage_Header}</h2>
    </div>

    <div class="action-buttons">
      <button onclick={handleInMileageEntries} class="action-button">
        <span class="button-icon">
          <lightning-icon
            icon-name="utility:travel_and_places"
            size="small"
          ></lightning-icon>
        </span>
        <span class="button-text">
          <span class="button-label">{labels.Mileage_Start_Day}</span>
          <span class="button-description"
            >{labels.Mileage_View_Add_StartMileage}</span
          >
        </span>
      </button>

      <button onclick={handleOutMileageEntries} class="action-button">
        <span class="button-icon">
          <lightning-icon
            icon-name="utility:travel_and_places"
            size="small"
          ></lightning-icon>
        </span>
        <span class="button-text">
          <span class="button-label">{labels.Mileage_End_Day}</span>
          <span class="button-description"
            >{labels.Mileage_View_Add_EndMileage}</span
          >
        </span>
      </button>

      <button onclick={handleOwnMileageEntries} class="action-button">
        <span class="button-icon">
          <lightning-icon
            icon-name="utility:travel_and_places"
            size="small"
          ></lightning-icon>
        </span>
        <span class="button-text">
          <span class="button-label">{labels.Mileage_Own}</span>
          <span class="button-description"
            >{labels.Mileage_View_Add_OwnMileage}</span
          >
        </span>
      </button>
    </div>

    <div class="footer">
      <button onclick={handleBackToMenu} class="submit-button">
        <span class="button-icon">
          <lightning-icon
            icon-name="utility:left"
            size="small"
            variant="inverse"
          ></lightning-icon>
        </span>
        <span class="button-text">{labels.Mileage_Return_Button}</span>
      </button>
    </div>
  </div>

  <!-- Mileage Entries Modal -->
  <template if:true={showMileageEntries}>
    <div class="mobile-backdrop" onclick={handleCloseForm}></div>
    <div class="mobile-bottom-sheet large-sheet">
      <div class="bottom-sheet-header">
        <div class="drag-indicator"></div>
        <h2 class="sheet-title">{labels.Mileage_Entries_Header}</h2>
      </div>
      <div class="bottom-sheet-content">
        <div class="MileageEntries-container">
          <template for:each={mileageEntries} for:item="entry">
            <div class="MileageEntryContainer" key={entry.Id}>
              <div class="form-element">
                <label class="slds-form-element__label"
                  >{labels.Mileage_Allowance_FieldLabel}</label
                >
                <div class="slds-form-element__control">
                  <input
                    type="text"
                    readonly
                    class="slds-input"
                    value={entry.Allowance_Type__c}
                  />
                </div>
              </div>

              <div class="form-element">
                <label class="slds-form-element__label"
                  >{labels.Mileage_Starting_Mileage_FieldLabel}</label
                >
                <div class="slds-form-element__control">
                  <input
                    type="text"
                    readonly
                    class="slds-input"
                    value={entry.Starting_Mileage__c}
                  />
                </div>
              </div>

              <div class="form-element">
                <label class="slds-form-element__label"
                  >{labels.Mileage_Ending_Mileage_FieldLabel}</label
                >
                <div class="slds-form-element__control">
                  <input
                    type="text"
                    readonly
                    class="slds-input"
                    value={entry.Ending_Mileage__c}
                  />
                </div>
              </div>

              <div class="button-mileage-container">
                <button class="cancel-button" onclick={handleCloseForm}>
                  {labels.Mileage_Cancel_Button}
                </button>

                <button
                  class="submit-button"
                  onclick={handleMileageEntryEdit}
                  data-id={entry.Id}
                >
                  {labels.Mileage_Edit_Button}
                </button>
              </div>
            </div>
          </template>
        </div>
      </div>
    </div>
  </template>

  <!-- New Mileage Out Entry Form -->
  <template if:true={showOutMileageEntryNewForm}>
    <div class="mobile-backdrop" onclick={handleCloseForm}></div>
    <div class="mobile-bottom-sheet large-sheet">
      <div class="bottom-sheet-header">
        <div class="drag-indicator"></div>
        <h2 class="sheet-title">{labels.Mileage_New_Out_Header}</h2>
      </div>
      <div class="bottom-sheet-content">
        <lightning-record-edit-form
          object-api-name="Mileage_Entry__c"
          onsuccess={handleSuccessMileageEntryNew}
        >
          <lightning-messages></lightning-messages>
          <div class="form-fields">
            <div class="work-order-container">
              <div class="required-button-wrapper">
                <abbr class="slds-required" title="required">*</abbr>
                <button
                  onclick={handleSetAppointmentClicked}
                  type="button"
                  class="work-order-button"
                >
                  <lightning-icon
                    icon-name="utility:search"
                    size="xx-small"
                    variant="inverse"
                    class="slds-m-right_xx-small"
                  >
                  </lightning-icon>
                  {workOrderText}
                </button>
              </div>
              <lightning-input-field
                if:true={workOrderId}
                field-name="Work_Order__c"
                value={workOrderId}
                variant="label-hidden"
                required
                class="work-order-field"
              >
              </lightning-input-field>
            </div>

            <lightning-input-field
              field-name="Time_Sheet__c"
              value={recordId}
              class="slds-hide"
            ></lightning-input-field>
            <lightning-input-field
              field-name="Type__c"
              value="Ending"
              class="slds-hide"
            ></lightning-input-field>
            <lightning-input-field
              field-name="Service_Resource__c"
              value={timeSheetResourceId}
              class="slds-hide"
            ></lightning-input-field>

            <lightning-input-field
              field-name="Allowance_Type__c"
              required
            ></lightning-input-field>
            <lightning-input-field
              field-name="Starting_Mileage__c"
              required
            ></lightning-input-field>
            <lightning-input-field
              field-name="Ending_Mileage__c"
              required
            ></lightning-input-field>
          </div>
          <div class="button-group">
            <button
              class="cancel-button"
              type="button"
              onclick={handleCloseForm}
            >
              {labels.Mileage_Cancel_Button}
            </button>
            <button class="submit-button" type="submit">
              {labels.Mileage_Save_Button}
            </button>
          </div>
        </lightning-record-edit-form>
      </div>
    </div>
  </template>

  <!-- New Mileage In Entry Form -->
  <template if:true={showInMileageEntryNewForm}>
    <div class="mobile-backdrop" onclick={handleCloseForm}></div>
    <div class="mobile-bottom-sheet large-sheet">
      <div class="bottom-sheet-header">
        <div class="drag-indicator"></div>
        <h2 class="sheet-title">{labels.Mileage_New_In_Header}</h2>
      </div>
      <div class="bottom-sheet-content">
        <lightning-record-edit-form
          object-api-name="Mileage_Entry__c"
          onsuccess={handleSuccessMileageEntryNew}
        >
          <lightning-messages></lightning-messages>
          <div class="form-fields">
            <!-- Work Order -->

            <div class="work-order-container">
              <div class="required-button-wrapper">
                <abbr class="slds-required" title="required">*</abbr>
                <button
                  onclick={handleSetAppointmentClicked}
                  type="button"
                  class="work-order-button"
                >
                  <lightning-icon
                    icon-name="utility:search"
                    size="xx-small"
                    variant="inverse"
                    class="slds-m-right_xx-small"
                  >
                  </lightning-icon>
                  {workOrderText}
                </button>
              </div>
              <lightning-input-field
                if:true={workOrderId}
                field-name="Work_Order__c"
                value={workOrderId}
                variant="label-hidden"
                required
                class="work-order-field"
              >
              </lightning-input-field>
            </div>

            <lightning-input-field
              field-name="Time_Sheet__c"
              value={recordId}
              class="slds-hide"
            ></lightning-input-field>
            <lightning-input-field
              field-name="Type__c"
              value="Starting"
              class="slds-hide"
            ></lightning-input-field>
            <lightning-input-field
              field-name="Service_Resource__c"
              value={timeSheetResourceId}
              class="slds-hide"
            ></lightning-input-field>

            <lightning-input-field
              field-name="Allowance_Type__c"
              required
            ></lightning-input-field>

            <!-- <div class="slds-size_1-of-2 slds-var-p-around_x-small">
              <div class="slds-form-element__label slds-var-m-left_xx-small">
                Allowance Test
              </div>
              <lightning-input-field
                field-name="Allowance_Type__c"
                required
                variant="label-hidden"
              ></lightning-input-field>
            </div> -->

            <lightning-input-field
              field-name="Starting_Mileage__c"
              required
            ></lightning-input-field>
            <lightning-input-field
              field-name="Ending_Mileage__c"
              required
            ></lightning-input-field>
          </div>
          <div class="button-group">
            <button
              class="cancel-button"
              type="button"
              onclick={handleCloseForm}
            >
              {labels.Mileage_Cancel_Button}
            </button>
            <button class="submit-button" type="submit">
              {labels.Mileage_Save_Button}
            </button>
          </div>
        </lightning-record-edit-form>
      </div>
    </div>
  </template>

  <!-- Mileage Entry Edit Form -->
  <template if:true={showMileageEntryEditForm}>
    <div class="mobile-backdrop" onclick={handleCloseForm}></div>
    <div class="mobile-bottom-sheet large-sheet">
      <div class="bottom-sheet-header">
        <div class="drag-indicator"></div>
        <h2 class="sheet-title">{labels.Mileage_Edit_Entry_Header}</h2>
      </div>
      <div class="bottom-sheet-content">
        <lightning-record-edit-form
          object-api-name="Mileage_Entry__c"
          onsuccess={handleSuccessMileageEntryEdit}
          record-id={mileageEntryIdBeingHandled}
        >
          <lightning-messages></lightning-messages>
          <div class="form-fields">
            <lightning-input-field
              field-name="Starting_Mileage__c"
              class="form-element"
            ></lightning-input-field>
            <lightning-input-field
              field-name="Ending_Mileage__c"
              class="form-element"
            ></lightning-input-field>
          </div>
          <div class="button-group">
            <button
              class="cancel-button"
              type="button"
              onclick={handleCloseForm}
            >
              {labels.Mileage_Cancel_Button}
            </button>
            <button class="submit-button" type="submit">
              {labels.Mileage_Save_Button}
            </button>
          </div>
        </lightning-record-edit-form>
      </div>
    </div>
  </template>

  <!-- In Mileage Message Modal (No entries) -->
  <template if:true={showInMileageMessage}>
    <div class="mobile-backdrop" onclick={handleCloseForm}></div>
    <div class="mobile-bottom-sheet">
      <div class="bottom-sheet-header">
        <div class="drag-indicator"></div>
        <h2 class="sheet-title">{labels.Mileage_In_Header}</h2>
      </div>
      <div class="bottom-sheet-content">
        <div class="action-buttons">
          <button onclick={handleNewInMileageEntry} class="action-button">
            <span class="button-icon">
              <lightning-icon
                icon-name="utility:travel_and_places"
                size="small"
              ></lightning-icon>
            </span>
            <span class="button-text">
              <span class="button-label">{labels.Mileage_Add_In_Entry}</span>
              <span class="button-description"
                >{labels.Mileage_Add_In_Entry_Description}</span
              >
            </span>
          </button>
        </div>
        <button class="cancel-button" onclick={handleCloseForm}>
          {labels.Mileage_Cancel_Button}
        </button>
      </div>
    </div>
  </template>

  <!-- Out Mileage Message Modal (No entries) -->
  <template if:true={showOutMileageMessage}>
    <div class="mobile-backdrop" onclick={handleCloseForm}></div>
    <div class="mobile-bottom-sheet">
      <div class="bottom-sheet-header">
        <div class="drag-indicator"></div>
        <h2 class="sheet-title">{labels.Mileage_Out_Header}</h2>
      </div>
      <div class="bottom-sheet-content">
        <div class="action-buttons">
          <button onclick={handleNewOutMileageEntry} class="action-button">
            <span class="button-icon">
              <lightning-icon
                icon-name="utility:travel_and_places"
                size="small"
              ></lightning-icon>
            </span>
            <span class="button-text">
              <span class="button-label">{labels.Mileage_Add_Out_Entry}</span>
              <span class="button-description"
                >{labels.Mileage_Add_Out_Entry_Description}</span
              >
            </span>
          </button>
        </div>
        <button class="cancel-button" onclick={handleCloseForm}>
          {labels.Mileage_Cancel_Button}
        </button>
      </div>
    </div>
  </template>

  <!-- Own Mileage Message Modal (No entries) -->
  <template if:true={showOwnMileageMessage}>
    <div class="mobile-backdrop" onclick={handleCloseForm}></div>
    <div class="mobile-bottom-sheet">
      <div class="bottom-sheet-header">
        <div class="drag-indicator"></div>
        <h2 class="sheet-title">{labels.Mileage_Own_Header}</h2>
      </div>
      <div class="bottom-sheet-content">
        <div class="warning-container">
          <div class="warning-icon">
            <lightning-icon
              icon-name="utility:warning"
              size="small"
              variant="warning"
            ></lightning-icon>
          </div>
          <p class="warning-text">{labels.Mileage_Own_No_Entries_Message}</p>
        </div>
        <button class="cancel-button" onclick={handleCloseForm}>
          {labels.Mileage_Cancel_Button}
        </button>
      </div>
    </div>
  </template>

  <template if:true={showAppointmentScreen}>
    <div class="mobile-backdrop" onclick={handleCloseForm}></div>
    <div
      class="mobile-bottom-sheet large-sheet"
      style="height: 100vh; max-height: 100vh"
    >
      <div class="bottom-sheet-header">
        <div class="drag-indicator"></div>
        <h2 class="sheet-title">{labels.Mileage_SelectAppointmentText}</h2>
      </div>
      <div class="bottom-sheet-content" style="height: calc(100vh - 120px)">
        <div
          class="table-container"
          style="height: calc(100% - 60px); overflow-y: auto; width: 100%"
        >
          <div class="datatable-wrapper" style="width: 100%">
            <lightning-datatable
              class="slds-table_striped slds-cell-wrap"
              columns={columns}
              data={serviceAppointments}
              key-field="Id"
              max-row-selection="1"
              wrap-text-max-lines="3"
              onrowselection={handleRowSelection}
            >
            </lightning-datatable>
          </div>
        </div>
        <div
          class="button-group"
          style="
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 1rem;
            background: white;
          "
        >
          <button class="cancel-button" type="button" onclick={handleCloseForm}>
            {labels.Mileage_Cancel_Button}
          </button>
          <button
            class="submit-button"
            disabled={disableNextButton}
            onclick={handleNext}
            type="button"
          >
            {labels.Mileage_NextButtonText}
          </button>
        </div>
      </div>
    </div>
  </template>
</template>