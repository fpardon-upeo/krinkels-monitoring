<template>
  <div class="calendar-container">
    <template if:true={isLoading}>
      <lightning-spinner
        alternative-text="Loading"
        size="medium"
      ></lightning-spinner>
    </template>

    <!-- Combined Stats and Mileage Buttons Section -->
    <div class="top-section">
      <!-- Stats Container -->
      <div class="stats-container">
        <div class="stat-card">
          <div class="stat-iconAndInfo-container">
            <div class="stat-icon">
              <lightning-icon
                icon-name="utility:clock"
                size="small"
                class="work-icon"
              ></lightning-icon>
            </div>
            <div class="stat-info">
              <span class="stat-label">Work Hours</span>
              <span class="stat-value">{workHours}h</span>
            </div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-iconAndInfo-container">
            <div class="stat-icon">
              <lightning-icon
                icon-name="utility:travel_and_places"
                size="small"
                class="travel-icon"
              ></lightning-icon>
            </div>
            <div class="stat-info">
              <span class="stat-label">Travel Hours</span>
              <span class="stat-value">{travelHours}h</span>
            </div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-iconAndInfo-container">
            <div class="stat-icon">
              <lightning-icon
                icon-name="utility:tour"
                size="small"
                class="km-icon"
              ></lightning-icon>
            </div>
            <div class="stat-info">
              <span class="stat-label">Total KM</span>
              <span class="stat-value">{kmAmount}km</span>
            </div>
          </div>
          <button class="info-button" onclick={handleShowMileageInfo}>
            Info
          </button>
        </div>

        <div class="stat-card">
          <div class="slds-grid_vertical">
            <div class="stat-iconAndInfo-container">
              <div class="stat-icon">
                <lightning-icon
                  icon-name="utility:summary"
                  size="small"
                  class="total-icon"
                ></lightning-icon>
              </div>
              <div class="stat-info">
                <span class="stat-label">Total Hours</span>
                <span class="stat-value">{totalHours}h</span>
              </div>
            </div>
            <div class="stat-iconAndInfo-container slds-var-m-top_small">
              <div class="stat-icon">
                <lightning-icon
                  icon-name="utility:food_and_drink"
                  size="small"
                  class="total-icon"
                ></lightning-icon>
              </div>
              <div class="stat-info">
                <span class="stat-label">Total Break</span>
                <span class="stat-value">{totalBreakHours}h</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <template if:false={showNoEntriesModal}>
      <div class="refreshButton-container">
        <button class="refreshButton" onclick={handleRefresh}>
          <lightning-icon icon-name="utility:refresh"></lightning-icon>
        </button>
      </div>

      <!-- Calendar -->
      <div class="fullcalendar"></div>
    </template>

    <template if:true={showNoEntriesModal}>
      <div class="noEntries-container">
        <p class="noEntries-text">
          No entries or breaks found for this time sheet.
        </p>
      </div>
    </template>
  </div>

  <!-- Static Footer -->
  <template if:false={isTimeSheetSubmittedOrApproved}>
    <div class="footer">
      <button
        onclick={handleSubmitTimeSheetMessage}
        class="submit-buttonSecond"
      >
        Submit for Approval
      </button>
    </div>
  </template>

  <!-- New TimeSheet or Absence Entry Modal -->
  <template if:true={showNewTimeSheetOrAbsenceModal}>
    <div class="mobile-backdrop" onclick={handleCloseForm}></div>
    <div class="mobile-bottom-sheet">
      <div class="bottom-sheet-header">
        <div class="drag-indicator"></div>
        <h2 class="sheet-title">Create New Entry</h2>
      </div>
      <div class="bottom-sheet-content">
        <div class="action-buttons">
          <button
            onclick={createTimeSheetEntry}
            class="action-button timesheet-button"
          >
            <span class="button-icon">
              <lightning-icon
                icon-name="utility:clock"
                size="small"
              ></lightning-icon>
            </span>
            <span class="button-text">
              <span class="button-label">Add Time Sheet Entry</span>
              <span class="button-description"
                >Record work hours or other activities</span
              >
            </span>
          </button>

          <button
            onclick={createResourceAbsence}
            class="action-button break-button"
          >
            <span class="button-icon">
              <lightning-icon
                icon-name="utility:pause"
                size="small"
              ></lightning-icon>
            </span>
            <span class="button-text">
              <span class="button-label">Add Break</span>
              <span class="button-description">Record break time</span>
            </span>
          </button>
        </div>

        <button class="cancel-button" onclick={handleCloseForm}>Cancel</button>
      </div>
    </div>
  </template>

  <!-- Mileage Info Modal -->
  <template if:true={showMileageInfoModal}>
    <div class="mobile-backdrop" onclick={handleCloseForm}></div>
    <div class="mobile-bottom-sheet">
      <div class="bottom-sheet-header">
        <div class="drag-indicator"></div>
        <h2 class="sheet-title">Mileage Options</h2>
      </div>
      <div class="bottom-sheet-content">
        <div class="action-buttons">
          <button onclick={handleInMileageEntries} class="action-button">
            <span class="button-icon">
              <lightning-icon
                icon-name="utility:travel_and_places"
                size="small"
              ></lightning-icon>
            </span>
            <span class="button-text">
              <span class="button-label">In Mileage Entries</span>
              <span class="button-description"
                >View or add in mileage records</span
              >
            </span>
          </button>

          <button onclick={handleOutMileageEntries} class="action-button">
            <span class="button-icon">
              <lightning-icon
                icon-name="utility:travel_and_places"
                size="small"
              ></lightning-icon>
            </span>
            <span class="button-text">
              <span class="button-label">Out Mileage Entries</span>
              <span class="button-description"
                >View or add out mileage records</span
              >
            </span>
          </button>
        </div>

        <button class="cancel-button" onclick={handleCloseForm}>Cancel</button>
      </div>
    </div>
  </template>

  <!-- Mileage Entries Modal -->
  <template if:true={showMileageEntries}>
    <div class="mobile-backdrop" onclick={handleCloseForm}></div>
    <div class="mobile-bottom-sheet large-sheet">
      <div class="bottom-sheet-header">
        <div class="drag-indicator"></div>
        <h2 class="sheet-title">Mileage Entries</h2>
      </div>
      <div class="bottom-sheet-content">
        <div class="MileageEntries-container">
          <template for:each={mileageEntries} for:item="entry">
            <div class="MileageEntryContainer" key={entry.Id}>
              <div class="form-element">
                <label class="slds-form-element__label"
                  >Starting Location</label
                >
                <div class="slds-form-element__control">
                  <input
                    type="text"
                    readonly
                    class="slds-input"
                    value={entry.Starting_Location_Type__c}
                  />
                </div>
              </div>

              <div class="form-element">
                <label class="slds-form-element__label">Ending Location</label>
                <div class="slds-form-element__control">
                  <input
                    type="text"
                    readonly
                    class="slds-input"
                    value={entry.Ending_Location_Type__c}
                  />
                </div>
              </div>

              <div class="form-element">
                <label class="slds-form-element__label">Allowance</label>
                <div class="slds-form-element__control">
                  <input
                    type="text"
                    readonly
                    class="slds-input"
                    value={entry.Allowance_Type__c}
                  />
                </div>
              </div>

              <div class="form-element">
                <label class="slds-form-element__label">Starting Mileage</label>
                <div class="slds-form-element__control">
                  <input
                    type="text"
                    readonly
                    class="slds-input"
                    value={entry.Starting_Mileage__c}
                  />
                </div>
              </div>

              <div class="form-element">
                <label class="slds-form-element__label">Ending Mileage</label>
                <div class="slds-form-element__control">
                  <input
                    type="text"
                    readonly
                    class="slds-input"
                    value={entry.Ending_Mileage__c}
                  />
                </div>
              </div>

              <div class="button-mileage-container">
                <button class="cancel-button" onclick={handleCloseForm}>
                  Cancel
                </button>

                <button
                  class="submit-button"
                  onclick={handleMileageEntryEdit}
                  data-id={entry.Id}
                >
                  Edit
                </button>
              </div>
            </div>
          </template>
        </div>
      </div>
    </div>
  </template>

  <!-- Replace the In Mileage Message modal -->
  <template if:true={showInMileageMessage}>
    <div class="mobile-backdrop" onclick={handleCloseForm}></div>
    <div class="mobile-bottom-sheet">
      <div class="bottom-sheet-header">
        <div class="drag-indicator"></div>
        <h2 class="sheet-title">No In Mileage Entries Found</h2>
      </div>
      <div class="bottom-sheet-content">
        <div class="action-buttons">
          <button onclick={handleNewInMileageEntry} class="action-button">
            <span class="button-icon">
              <lightning-icon
                icon-name="utility:travel_and_places"
                size="small"
              ></lightning-icon>
            </span>
            <span class="button-text">
              <span class="button-label">Add In Mileage Entry</span>
              <span class="button-description"
                >Create a new in mileage record</span
              >
            </span>
          </button>
        </div>
        <button class="cancel-button" onclick={handleCloseForm}>Cancel</button>
      </div>
    </div>
  </template>

  <!-- Replace the Out Mileage Message modal -->
  <template if:true={showOutMileageMessage}>
    <div class="mobile-backdrop" onclick={handleCloseForm}></div>
    <div class="mobile-bottom-sheet">
      <div class="bottom-sheet-header">
        <div class="drag-indicator"></div>
        <h2 class="sheet-title">No Out Mileage Entries Found</h2>
      </div>
      <div class="bottom-sheet-content">
        <div class="action-buttons">
          <button onclick={handleNewOutMileageEntry} class="action-button">
            <span class="button-icon">
              <lightning-icon
                icon-name="utility:travel_and_places"
                size="small"
              ></lightning-icon>
            </span>
            <span class="button-text">
              <span class="button-label">Add Out Mileage Entry</span>
              <span class="button-description"
                >Create a new out mileage record</span
              >
            </span>
          </button>
        </div>
        <button class="cancel-button" onclick={handleCloseForm}>Cancel</button>
      </div>
    </div>
  </template>

  <!-- Submit Time Sheet Message Modal -->
  <template if:true={submitTimeSheetMessage}>
    <div class="mobile-backdrop" onclick={handleCloseForm}></div>
    <div class="mobile-bottom-sheet">
      <div class="bottom-sheet-header">
        <div class="drag-indicator"></div>
        <h2 class="sheet-title">Submit Time Sheet</h2>
      </div>
      <div class="bottom-sheet-content">
        <div class="warning-container">
          <div class="warning-icon">
            <lightning-icon
              icon-name="utility:warning"
              size="small"
              variant="warning"
            ></lightning-icon>
          </div>
          <p class="warning-text">
            Warning: After submission, this timesheet will be locked and cannot
            be edited.
          </p>
        </div>
        <div class="button-group">
          <button class="cancel-button" onclick={handleCloseForm}>
            Cancel
          </button>
          <button class="submit-button" onclick={handleSubmitTimeSheet}>
            Submit
          </button>
        </div>
      </div>
    </div>
  </template>

  <!--//////////////////////////////////////////////////////////////////////////////-->

  <!-- New Mileage Out Entry Form -->
  <template if:true={showOutMileageEntryNewForm}>
    <div class="mobile-backdrop" onclick={handleCloseForm}></div>
    <div class="mobile-bottom-sheet large-sheet">
      <div class="bottom-sheet-header">
        <div class="drag-indicator"></div>
        <h2 class="sheet-title">New Out Mileage Entry</h2>
      </div>
      <div class="bottom-sheet-content">
        <lightning-record-edit-form
          object-api-name="Mileage_Entry__c"
          onsuccess={handleSuccessMileageEntryNew}
        >
          <lightning-messages></lightning-messages>
          <div class="form-fields">
            <lightning-input-field
              field-name="Time_Sheet__c"
              value={recordId}
              class="slds-hide"
            ></lightning-input-field>
            <lightning-input-field
              field-name="Type__c"
              value="Ending"
              class="slds-hide"
            ></lightning-input-field>
            <lightning-input-field
              field-name="Service_Resource__c"
              value={timeSheetResourceId}
              class="slds-hide"
            ></lightning-input-field>
            <lightning-input-field
              field-name="Starting_Location_Type__c"
              required
            ></lightning-input-field>
            <lightning-input-field
              field-name="Ending_Location_Type__c"
              value="Home"
            ></lightning-input-field>
            <lightning-input-field
              field-name="Allowance_Type__c"
              required
            ></lightning-input-field>
            <lightning-input-field
              field-name="Starting_Mileage__c"
              required
            ></lightning-input-field>
            <lightning-input-field
              field-name="Ending_Mileage__c"
              required
            ></lightning-input-field>
          </div>
          <div class="button-group">
            <button class="cancel-button" onclick={handleCloseForm}>
              Cancel
            </button>
            <button class="submit-button" type="submit">Save</button>
          </div>
        </lightning-record-edit-form>
      </div>
    </div>
  </template>

  <!-- New Mileage In Entry Form -->
  <template if:true={showInMileageEntryNewForm}>
    <div class="mobile-backdrop" onclick={handleCloseForm}></div>
    <div class="mobile-bottom-sheet large-sheet">
      <div class="bottom-sheet-header">
        <div class="drag-indicator"></div>
        <h2 class="sheet-title">New In Mileage Entry</h2>
      </div>
      <div class="bottom-sheet-content">
        <lightning-record-edit-form
          object-api-name="Mileage_Entry__c"
          onsuccess={handleSuccessMileageEntryNew}
        >
          <lightning-messages></lightning-messages>
          <div class="form-fields">
            <lightning-input-field
              field-name="Type__c"
              value="Starting"
              class="slds-hide"
            ></lightning-input-field>
            <lightning-input-field
              field-name="Time_Sheet__c"
              value={recordId}
              class="slds-hide"
            ></lightning-input-field>
            <lightning-input-field
              field-name="Service_Resource__c"
              value={timeSheetResourceId}
              class="slds-hide"
            ></lightning-input-field>
            <lightning-input-field
              field-name="Starting_Location_Type__c"
              value="Home"
            ></lightning-input-field>
            <lightning-input-field
              field-name="Ending_Location_Type__c"
              required
            ></lightning-input-field>
            <lightning-input-field
              field-name="Allowance_Type__c"
              required
            ></lightning-input-field>
            <lightning-input-field
              field-name="Starting_Mileage__c"
              required
            ></lightning-input-field>
            <lightning-input-field
              field-name="Ending_Mileage__c"
              required
            ></lightning-input-field>
          </div>
          <div class="button-group">
            <button class="cancel-button" onclick={handleCloseForm}>
              Cancel
            </button>
            <button class="submit-button" type="submit">Save</button>
          </div>
        </lightning-record-edit-form>
      </div>
    </div>
  </template>

  <!-- New TimeSheetEntry Form -->
  <template if:true={showTimeSheetEntryNewForm}>
    <div
      class="mobile-backdrop"
      onclick={handleCloseNewTimeSheetOrAbsenceEntry}
    ></div>
    <div class="mobile-bottom-sheet large-sheet">
      <div class="bottom-sheet-header">
        <div class="drag-indicator"></div>
        <h2 class="sheet-title">New Time Sheet Entry</h2>
      </div>
      <div class="bottom-sheet-content">
        <c-timesheet-entry-form
          start-date={startDate}
          end-date={endDate}
          time-sheet-id={recordId}
          service-resource-id={timeSheetResourceId}
          start-date-and-hours={startDateAndHours}
          end-date-and-hours={endDateAndHours}
          ontimesheetcreated={handleSuccessTimeSheetOrAbsenceEntry}
          oncloseform={handleCloseForm}
        ></c-timesheet-entry-form>
      </div>
    </div>
  </template>

  <!-- Resource Absence New Form -->
  <template if:true={showResourceAbsenceNewForm}>
    <div class="mobile-backdrop" onclick={handleCloseForm}></div>
    <div class="mobile-bottom-sheet large-sheet">
      <div class="bottom-sheet-header">
        <div class="drag-indicator"></div>
        <h2 class="sheet-title">New Break Entry</h2>
      </div>
      <div class="bottom-sheet-content">
        <lightning-record-edit-form
          object-api-name="ResourceAbsence"
          record-type-id={breakRecordTypeId}
          onsuccess={handleSuccessTimeSheetOrAbsenceEntry}
        >
          <lightning-messages></lightning-messages>

          <div class="form-fields">
            <lightning-input-field
              field-name="ResourceId"
              value={timeSheetResourceId}
              class="slds-hide"
            >
            </lightning-input-field>

            <lightning-input-field
              field-name="Start"
              value={startDateAndHours}
              required
              class="form-element"
            >
            </lightning-input-field>

            <lightning-input-field
              field-name="End"
              value={endDateAndHours}
              required
              class="form-element"
            >
            </lightning-input-field>

            <lightning-input-field
              field-name="Type"
              required
              class="form-element"
            >
            </lightning-input-field>

            <lightning-input-field
              field-name="Description"
              class="form-element"
            >
            </lightning-input-field>
          </div>

          <div class="button-group">
            <button class="cancel-button" onclick={handleCloseForm}>
              Cancel
            </button>
            <button class="submit-button" type="submit">Save</button>
          </div>
        </lightning-record-edit-form>
      </div>
    </div>
  </template>

  <!-- TimeSheet Entry Edit Form -->
  <template if:true={showTimeSheetEntryEditForm}>
    <div class="mobile-backdrop" onclick={handleCloseForm}></div>
    <div class="mobile-bottom-sheet large-sheet">
      <div class="bottom-sheet-header">
        <div class="drag-indicator"></div>
        <h2 class="sheet-title">Edit Time Sheet Entry</h2>
      </div>
      <div class="bottom-sheet-content">
        <lightning-record-edit-form
          object-api-name="TimeSheetEntry"
          onsuccess={handleSuccessTimeSheetOrAbsenceEntry}
          record-id={recordIdBeingHandled}
        >
          <lightning-messages></lightning-messages>

          <div class="form-fields">
            <lightning-input-field field-name="StartTime" class="form-element">
            </lightning-input-field>

            <lightning-input-field field-name="EndTime" class="form-element">
            </lightning-input-field>

            <lightning-input-field
              field-name="Type"
              class="form-element"
              required
            >
            </lightning-input-field>

            <lightning-input-field field-name="Subject" class="form-element">
            </lightning-input-field>
          </div>

          <div class="button-group">
            <button class="cancel-button" onclick={handleCloseForm}>
              Cancel
            </button>
            <button class="submit-button" type="submit">Save</button>
          </div>
        </lightning-record-edit-form>
      </div>
    </div>
  </template>

  <!-- Resource Absence Edit Form -->
  <template if:true={showResourceAbsenceEditForm}>
    <div class="mobile-backdrop" onclick={handleCloseForm}></div>
    <div class="mobile-bottom-sheet large-sheet">
      <div class="bottom-sheet-header">
        <div class="drag-indicator"></div>
        <h2 class="sheet-title">Edit Break Entry</h2>
      </div>
      <div class="bottom-sheet-content">
        <lightning-record-edit-form
          object-api-name="ResourceAbsence"
          onsuccess={handleSuccessTimeSheetOrAbsenceEntry}
          record-id={recordIdBeingHandled}
        >
          <lightning-messages></lightning-messages>

          <div class="form-fields">
            <lightning-input-field field-name="Start" class="form-element">
            </lightning-input-field>

            <lightning-input-field field-name="End" class="form-element">
            </lightning-input-field>

            <lightning-input-field field-name="Type" class="form-element">
            </lightning-input-field>

            <lightning-input-field
              field-name="Description"
              class="form-element"
            >
            </lightning-input-field>
          </div>

          <div class="button-group">
            <button class="cancel-button" onclick={handleCloseForm}>
              Cancel
            </button>
            <button class="submit-button" type="submit">Save</button>
          </div>
        </lightning-record-edit-form>
      </div>
    </div>
  </template>

  <!-- Mileage Entry Edit Form -->
  <template if:true={showMileageEntryEditForm}>
    <div class="mobile-backdrop" onclick={handleCloseForm}></div>
    <div class="mobile-bottom-sheet large-sheet">
      <div class="bottom-sheet-header">
        <div class="drag-indicator"></div>
        <h2 class="sheet-title">Edit Mileage Entry</h2>
      </div>
      <div class="bottom-sheet-content">
        <lightning-record-edit-form
          object-api-name="Mileage_Entry__c"
          onsuccess={handleSuccessMileageEntryEdit}
          record-id={mileageEntryIdBeingHandled}
        >
          <lightning-messages></lightning-messages>

          <div class="form-fields">
            <lightning-input-field
              field-name="Starting_Mileage__c"
              class="form-element"
            >
            </lightning-input-field>

            <lightning-input-field
              field-name="Ending_Mileage__c"
              class="form-element"
            >
            </lightning-input-field>
          </div>

          <div class="button-group">
            <button class="cancel-button" onclick={handleCloseForm}>
              Cancel
            </button>
            <button class="submit-button" type="submit">Save</button>
          </div>
        </lightning-record-edit-form>
      </div>
    </div>
  </template>

  <!--//////////////////////////////////////////////////////////////////////////////-->
</template>