<!--
 - Created by fpardon on 11/12/2024.
 -->

<!-- Rework Visit Form -->
<template>
  <!-- Progress Path -->
  <div class="slds-tabs_path" role="application">
    <ul class="slds-tabs_path__nav" role="tablist">
      <li class={stepOneClass}>
        <span class="slds-tabs_path__link">
          {labels.ReworkVisitForm_ReworkInfoText}
        </span>
      </li>
      <li class={stepTwoClass}>
        <span class="slds-tabs_path__link">
          {labels.ReworkVisitForm_TaskSelectionText}
        </span>
      </li>
      <li class={stepThreeClass}>
        <span class="slds-tabs_path__link">
          {labels.ReworkVisitForm_ConfirmDetailsText}
        </span>
      </li>
    </ul>
  </div>

  <div class="slds-p-around_medium">
    <!-- Step 1: Basic Information -->
    <template if:true={isStepOne}>
      <div class="slds-form">
        <!-- Subject -->
        <div class="slds-form-element">
          <lightning-input
            label={labels.ReworkVisitForm_SubjectText}
            value={subject}
            onchange={handleSubjectChange}
            required
          >
          </lightning-input>
        </div>

        <!-- Rework Reason -->
        <div class="slds-form-element slds-p-top_medium">
          <lightning-combobox
            label={labels.ReworkVisitForm_ReworkReasonText}
            value={reworkReason}
            options={reworkReasonOptions}
            onchange={handleReasonChange}
            required
          >
          </lightning-combobox>
        </div>

        <!-- Task Type Selection -->
        <div class="slds-form-element slds-p-top_medium">
          <lightning-radio-group
            label={labels.ReworkVisitForm_ReworkTasksText}
            options={taskTypeOptions}
            value={selectedTaskType}
            onchange={handleTaskTypeChange}
            required
          >
          </lightning-radio-group>
        </div>
      </div>
    </template>

    <!-- Step 2: Task Selection -->
    <template if:true={isStepTwo}>
      <!-- Show if reusing existing tasks -->
      <template if:true={isRedoTasks}>
        <lightning-datatable
          key-field="Id"
          data={existingTasks}
          columns={columns}
          selected-rows={selectedTasks}
          onrowselection={handleTaskSelection}
        >
        </lightning-datatable>

        <div class="slds-p-top_medium">
          <lightning-input
            type="checkbox"
            label={labels.ReworkVisitForm_AddAdditionalTasksText}
            checked={showAdditionalTasks}
            onchange={handleAdditionalTasksChange}
          >
          </lightning-input>
        </div>
      </template>

      <!-- New Tasks Section -->
      <template if:true={showNewTasks}>
        <div class="slds-p-top_medium">
          <div class="slds-text-heading_small slds-p-bottom_small">
            {labels.ReworkVisitForm_NewTasksText}
          </div>
          <template for:each={newTasks} for:item="task" for:index="index">
            <div key={task.key} class="slds-p-bottom_small">
              <div class="slds-grid slds-gutters">
                <div class="slds-col slds-size_11-of-12">
                  <lightning-textarea
                    label={labels.ReworkVisitForm_TaskDescriptionText}
                    value={task.description}
                    onchange={handleTaskDescriptionChange}
                    data-index={index}
                  >
                  </lightning-textarea>
                </div>
                <div class="slds-col slds-size_1-of-12 slds-align-bottom">
                  <lightning-button-icon
                    icon-name="utility:delete"
                    variant="bare"
                    onclick={handleRemoveTask}
                    data-index={index}
                    alternative-text="Remove Task"
                  >
                  </lightning-button-icon>
                </div>
              </div>
            </div>
          </template>
          <lightning-button
            label={labels.ReworkVisitForm_AddTaskText}
            onclick={handleAddTask}
            variant="neutral"
            class="slds-p-top_small"
          >
          </lightning-button>
        </div>
      </template>
    </template>

    <!-- Step 3: Confirmation -->
    <template if:true={isStepThree}>
      <div class="slds-box slds-theme_default">
        <dl class="slds-dl_horizontal">
          <dt class="slds-dl_horizontal__label">
            {labels.ReworkVisitForm_SubjectText}:
          </dt>
          <dd class="slds-dl_horizontal__detail">{subject}</dd>

          <dt class="slds-dl_horizontal__label">
            {labels.ReworkVisitForm_ReworkReasonText}:
          </dt>
          <dd class="slds-dl_horizontal__detail">{reworkReason}</dd>

          <template if:true={hasSelectedTasks}>
            <dt class="slds-dl_horizontal__label">
              {labels.ReworkVisitForm_SelectedTasksText}:
            </dt>
            <dd class="slds-dl_horizontal__detail">
              <ul class="slds-list_dotted">
                <template for:each={selectedTasksDisplay} for:item="task">
                  <li key={task.Id}>{task.Description}</li>
                </template>
              </ul>
            </dd>
          </template>

          <template if:true={hasNewTasks}>
            <dt class="slds-dl_horizontal__label">
              {labels.ReworkVisitForm_NewTasksText}:
            </dt>
            <dd class="slds-dl_horizontal__detail">
              <ul class="slds-list_dotted">
                <template for:each={newTasks} for:item="task">
                  <li key={task.key}>{task.description}</li>
                </template>
              </ul>
            </dd>
          </template>
        </dl>
      </div>
    </template>

    <!-- Navigation Buttons -->
    <div class="slds-p-top_medium">
      <div class="slds-grid slds-grid_align-spread">
        <lightning-button
          label={labels.ReworkVisitForm_BackText}
          onclick={handleBack}
        >
        </lightning-button>
        <lightning-button
          label={nextButtonLabel}
          variant="brand"
          onclick={handleNextOrCreate}
          disabled={isNextDisabled}
        >
        </lightning-button>
      </div>
    </div>
  </div>

  <!-- Loading Spinner -->
  <template if:true={isLoading}>
    <lightning-spinner
      alternative-text="Loading"
      size="medium"
    ></lightning-spinner>
  </template>
</template>