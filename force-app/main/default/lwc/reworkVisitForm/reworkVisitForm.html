<!--
 - Created by fpardon on 11/12/2024.
 -->

<!-- Rework Visit Form -->
<template>
    <!-- Progress Path -->
    <div class="slds-tabs_path" role="application">
        <ul class="slds-tabs_path__nav" role="tablist">
            <li class={stepOneClass}>
                <span class="slds-tabs_path__link">Rework Information</span>
            </li>
            <li class={stepTwoClass}>
                <span class="slds-tabs_path__link">Task Selection</span>
            </li>
            <li class={stepThreeClass}>
                <span class="slds-tabs_path__link">Confirm Details</span>
            </li>
        </ul>
    </div>

    <div class="slds-p-around_medium">
        <!-- Step 1: Basic Information -->
        <template if:true={isStepOne}>
            <div class="slds-form">
                <!-- Subject -->
                <div class="slds-form-element">
                    <lightning-input
                            label="Subject"
                            value={subject}
                            onchange={handleSubjectChange}
                            required>
                    </lightning-input>
                </div>

                <!-- Rework Reason -->
                <div class="slds-form-element slds-p-top_medium">
                    <lightning-combobox
                            label="Rework Reason"
                            value={reworkReason}
                            options={reworkReasonOptions}
                            onchange={handleReasonChange}
                            required>
                    </lightning-combobox>
                </div>

                <!-- Task Type Selection -->
                <div class="slds-form-element slds-p-top_medium">
                    <lightning-radio-group
                            label="Rework Tasks"
                            options={taskTypeOptions}
                            value={selectedTaskType}
                            onchange={handleTaskTypeChange}
                            required>
                    </lightning-radio-group>
                </div>
            </div>
        </template>

        <!-- Step 2: Task Selection -->
        <template if:true={isStepTwo}>
            <!-- Show if reusing existing tasks -->
            <template if:true={isRedoTasks}>
                <lightning-datatable
                        key-field="Id"
                        data={existingTasks}
                        columns={columns}
                        selected-rows={selectedTasks}
                        onrowselection={handleTaskSelection}>
                </lightning-datatable>

                <div class="slds-p-top_medium">
                    <lightning-input
                            type="checkbox"
                            label="Add additional tasks"
                            checked={showAdditionalTasks}
                            onchange={handleAdditionalTasksChange}>
                    </lightning-input>
                </div>
            </template>

            <!-- New Tasks Section -->
            <template if:true={showNewTasks}>
                <div class="slds-p-top_medium">
                    <div class="slds-text-heading_small slds-p-bottom_small">New Tasks</div>
                    <template for:each={newTasks} for:item="task" for:index="index">
                        <div key={task.key} class="slds-p-bottom_small">
                            <div class="slds-grid slds-gutters">
                                <div class="slds-col slds-size_11-of-12">
                                    <lightning-textarea
                                            label="Task Description"
                                            value={task.description}
                                            onchange={handleTaskDescriptionChange}
                                            data-index={index}>
                                    </lightning-textarea>
                                </div>
                                <div class="slds-col slds-size_1-of-12 slds-align-bottom">
                                    <lightning-button-icon
                                            icon-name="utility:delete"
                                            variant="bare"
                                            onclick={handleRemoveTask}
                                            data-index={index}
                                            alternative-text="Remove Task">
                                    </lightning-button-icon>
                                </div>
                            </div>
                        </div>
                    </template>
                    <lightning-button
                            label="Add Task"
                            onclick={handleAddTask}
                            variant="neutral"
                            class="slds-p-top_small">
                    </lightning-button>
                </div>
            </template>
        </template>

        <!-- Step 3: Confirmation -->
        <template if:true={isStepThree}>
            <div class="slds-box slds-theme_default">
                <dl class="slds-dl_horizontal">
                    <dt class="slds-dl_horizontal__label">Subject:</dt>
                    <dd class="slds-dl_horizontal__detail">{subject}</dd>

                    <dt class="slds-dl_horizontal__label">Rework Reason:</dt>
                    <dd class="slds-dl_horizontal__detail">{reworkReason}</dd>

                    <template if:true={hasSelectedTasks}>
                        <dt class="slds-dl_horizontal__label">Selected Tasks:</dt>
                        <dd class="slds-dl_horizontal__detail">
                            <ul class="slds-list_dotted">
                                <template for:each={selectedTasksDisplay} for:item="task">
                                    <li key={task.Id}>{task.Description}</li>
                                </template>
                            </ul>
                        </dd>
                    </template>

                    <template if:true={hasNewTasks}>
                        <dt class="slds-dl_horizontal__label">New Tasks:</dt>
                        <dd class="slds-dl_horizontal__detail">
                            <ul class="slds-list_dotted">
                                <template for:each={newTasks} for:item="task">
                                    <li key={task.key}>{task.description}</li>
                                </template>
                            </ul>
                        </dd>
                    </template>
                </dl>
            </div>
        </template>

        <!-- Navigation Buttons -->
        <div class="slds-p-top_medium">
            <div class="slds-grid slds-grid_align-spread">
                <lightning-button
                        label="Back"
                        onclick={handleBack}>
                </lightning-button>
                <lightning-button
                        label={nextButtonLabel}
                        variant="brand"
                        onclick={handleNextOrCreate}
                        disabled={isNextDisabled}>
                </lightning-button>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <template if:true={isLoading}>
        <lightning-spinner alternative-text="Loading" size="medium"></lightning-spinner>
    </template>
</template>